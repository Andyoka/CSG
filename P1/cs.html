<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produksi 1 - Cold Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #sidebar { transition: all 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .text-neon-green { color: #4ade80; }
        .bg-neon-green { background-color: #4ade80; }
        .border-neon-green { border-color: #4ade80; }
        #sheetFrame { transition: opacity 0.3s ease; }
        
        .chart-table { width: 100%; border-collapse: collapse; font-size: 10px; color: #1e293b; }
        .chart-table th, .chart-table td { border: 1px solid #cbd5e1; padding: 6px 4px; text-align: center; }
        .chart-table th { background-color: #f1f5f9; font-weight: bold; }
        .legend-box { width: 10px; height: 10px; display: inline-block; margin-right: 6px; border-radius: 2px; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4ade80;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans overflow-x-hidden">

    <aside id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-[#1e293b] text-white z-50 shadow-2xl">
        <div class="p-6 text-center">
            <div class="border-2 border-neon-green rounded-md py-1 px-2">
                <span class="text-sm font-black uppercase tracking-tighter text-neon-green">PRODUKSI 1</span>
            </div>
        </div>
        <nav class="mt-4 px-2">
            <a href="index.html" class="flex items-center py-2 px-4 mb-1 hover:bg-slate-700 transition rounded-md text-gray-400">üè† Home</a>
            <a href="cs.html" class="flex items-center py-2 px-4 mb-1 bg-neon-green text-black font-bold rounded-md shadow-lg">‚ùÑÔ∏è Cold Storage</a>
            <a href="fj.html" class="flex items-center py-2 px-4 mb-1 hover:bg-slate-700 transition rounded-md text-gray-400">ü•§ Fish Juice</a>
            <a href="fm.html" class="flex items-center py-2 px-4 mb-1 hover:bg-slate-700 transition rounded-md text-gray-400">üêü Fish Meal</a>
            <a href="rm.html" class="flex items-center py-2 px-4 mb-1 hover:bg-slate-700 transition rounded-md text-gray-400">üì¶ Raw Material</a>
        </nav>
    </aside>

    <main id="mainContent" class="ml-56 p-4 main-content">
        <header class="flex justify-between items-center mb-6 bg-[#1e293b] text-white p-3 rounded-lg shadow-md border-l-4 border-neon-green">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="bg-slate-700 p-2 rounded mr-4 hover:bg-slate-600 transition text-xs">‚ò∞ Menu</button>
                <h1 class="text-xl font-bold uppercase tracking-tight">Overview Stock <span class="text-neon-green">CS ATI-1</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="loader" id="loader"></div>
                <button onclick="refreshAll()" class="bg-neon-green text-black px-4 py-1 rounded text-[10px] font-black hover:bg-green-400 transition">üîÑ REFRESH SEMUA DATA</button>
            </div>
        </header>

        <section class="mb-6 bg-white p-5 rounded-xl shadow-lg border border-gray-200">
            <h3 class="text-center font-bold text-slate-800 mb-4 text-md uppercase">Grafik Overview Stock (Skala 100%)</h3>
            
            <div class="h-[380px] w-full mb-6">
                <canvas id="stockChart"></canvas>
            </div>

            <div class="overflow-x-auto border rounded-lg">
                <table class="chart-table" id="dataTable">
                    <thead>
                        <tr id="tableHeader" class="bg-slate-100">
                            <th class="text-left px-4 border-r">Category</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="bg-slate-800 p-2 flex justify-between items-center px-4">
                <span class="text-white text-[10px] font-bold uppercase tracking-widest">Detail Laporan Mingguan</span>
                <span class="text-neon-green text-[9px] font-mono">LIVE CONNECTION</span>
            </div>
            <div class="w-full bg-white">
                <iframe id="sheetFrame" src="" class="w-full h-[650px] border-none"></iframe>
            </div>
        </section>
    </main>

    <script>
        // === KONFIGURASI ID SHEET ===
        const ID_OVERVIEW = "2PACX-1vShq3eIcceGMXuR6dBbMut6K99pAQZV4g86Aq5DWkP7yrFTGNMPkdfg4y6vbWeofWpFRO4gGNqLE4h8"; 
        const GID_OVERVIEW = "0"; 
        const ID_LAPORAN = "2PACX-1vRQ6OPRqsuPRmTvAgsJNrU1ISOZ4x-0r1WSmpziuRNdecq42VVxgqferykNrUjJrB-KPWbt_NxgkpFk"; 

        let stockChart;
        const colors = { PS: "#5b9bd5", PL: "#ed7d31", FIP: "#a5a5a5", MSC: "#ffc000" };

        function initChartAndTable(labels, dataObj) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockChart) stockChart.destroy();
            
            // Logika Stacked 100%
            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: Object.keys(dataObj).reverse().map(key => ({
                        label: key,
                        data: dataObj[key],
                        backgroundColor: colors[key],
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y + '%';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { 
                            stacked: true, 
                            min: 0, 
                            max: 100, 
                            ticks: { callback: value => value + "%", stepSize: 10 },
                            grid: { color: '#f1f5f9' }
                        }
                    }
                }
            });

            // Update Tabel
            const tHeader = document.getElementById('tableHeader');
            const tBody = document.getElementById('tableBody');
            tHeader.innerHTML = '<th class="text-left px-4 border-r">Category</th>';
            tBody.innerHTML = '';
            labels.forEach(l => {
                const th = document.createElement('th');
                th.innerText = l;
                tHeader.appendChild(th);
            });
            Object.keys(dataObj).reverse().forEach(key => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="text-left font-bold bg-slate-50 border-r px-2"><span class="legend-box" style="background:${colors[key]}"></span>${key}</td>`;
                dataObj[key].forEach(val => {
                    const td = document.createElement('td');
                    td.innerText = val + "%"; // Tampilkan dalam persen
                    row.appendChild(td);
                });
                tBody.appendChild(row);
            });
        }

        async function fetchOverview() {
            document.getElementById('loader').style.display = "block";
            try {
                const ts = new Date().getTime();
                const url = `https://docs.google.com/spreadsheets/d/e/${ID_OVERVIEW}/pub?gid=${GID_OVERVIEW}&single=true&range=A1:N5&output=csv&t=${ts}`;
                const response = await fetch(url);
                const csv = await response.text();
                
                const rows = csv.split('\n').map(r => r.split(','));
                const labels = rows[0].slice(1);
                
                // Ambil nilai mentah
                const rawPS = rows[1].slice(1).map(v => parseFloat(v) || 0);
                const rawPL = rows[2].slice(1).map(v => parseFloat(v) || 0);
                const rawFIP = rows[3].slice(1).map(v => parseFloat(v) || 0);
                const rawMSC = rows[4].slice(1).map(v => parseFloat(v) || 0);

                // Hitung Persentase per Kolom
                const psPct = [], plPct = [], fipPct = [], mscPct = [];
                for(let i=0; i < labels.length; i++) {
                    const total = rawPS[i] + rawPL[i] + rawFIP[i] + rawMSC[i];
                    if(total > 0) {
                        psPct.push(Math.round((rawPS[i]/total) * 100));
                        plPct.push(Math.round((rawPL[i]/total) * 100));
                        fipPct.push(Math.round((rawFIP[i]/total) * 100));
                        mscPct.push(Math.round((rawMSC[i]/total) * 100));
                    } else {
                        psPct.push(0); plPct.push(0); fipPct.push(0); mscPct.push(0);
                    }
                }

                initChartAndTable(labels, { PS: psPct, PL: plPct, FIP: fipPct, MSC: mscPct });
            } catch (e) {
                console.error("Gagal load data.");
            }
            document.getElementById('loader').style.display = "none";
        }

        function refreshAll() {
            const frame = document.getElementById('sheetFrame');
            const ts = new Date().getTime();
            frame.src = `https://docs.google.com/spreadsheets/d/e/${ID_LAPORAN}/pubhtml?widget=true&headers=false&chrome=false&t=${ts}`;
            fetchOverview();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('sidebar-closed');
            mainContent.style.marginLeft = sidebar.classList.contains('sidebar-closed') ? "0" : "14rem";
        }

        window.onload = () => {
            if(!ID_OVERVIEW.includes("MASUKKAN")) refreshAll();
        };
    </script>
</body>
</html>