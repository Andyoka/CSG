<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produksi 1 - Cold Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        #sidebar { transition: all 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .text-neon-green { color: #4ade80; }
        .bg-neon-green { background-color: #4ade80; }
        .chart-table { width: 100%; border-collapse: collapse; font-size: 8px; color: #1e293b; }
        .chart-table th, .chart-table td { border: 1px solid #cbd5e1; padding: 2px; text-align: center; }
        .chart-table th { background-color: #f1f5f9; font-weight: bold; }
        .legend-box { width: 7px; height: 7px; display: inline-block; margin-right: 4px; border-radius: 2px; }
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #4ade80; border-radius: 50%;
            width: 18px; height: 18px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans overflow-x-hidden">

    <aside id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-[#1e293b] text-white z-50 shadow-2xl">
        <div class="p-6 text-center border-b border-slate-700">
            <div class="border-2 border-neon-green rounded-md py-1 px-2">
                <span class="text-sm font-black uppercase tracking-tighter text-neon-green">PRODUKSI 1</span>
            </div>
        </div>
        <nav class="mt-4 px-2">
            <a href="index.html" class="flex items-center py-2 px-4 mb-1 hover:bg-slate-700 transition rounded-md text-gray-400">üè† Home</a>
            <a href="cs.html" class="flex items-center py-2 px-4 mb-1 bg-neon-green text-black font-bold rounded-md shadow-lg">‚ùÑÔ∏è Cold Storage</a>
        </nav>
    </aside>

    <main id="mainContent" class="ml-56 p-4 main-content">
        <header class="flex justify-between items-center mb-4 bg-[#1e293b] text-white p-3 rounded-lg shadow-md border-l-4 border-neon-green">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="bg-slate-700 p-2 rounded mr-4 hover:bg-slate-600 transition text-xs">‚ò∞ Menu</button>
                <h1 class="text-lg font-bold uppercase tracking-tight">Dashboard <span class="text-neon-green">Cold Storage</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="loader" id="loader"></div>
                <button onclick="refreshAll()" class="bg-neon-green text-black px-4 py-1 rounded text-[10px] font-black hover:bg-green-400 transition shadow-md">üîÑ REFRESH</button>
            </div>
        </header>

        <div class="flex flex-wrap gap-4 mb-6 items-stretch">
            
            <section class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 w-full lg:w-[73%] flex flex-col justify-between">
                <div>
                    <h3 class="text-center font-bold text-slate-800 mb-2 text-[10px] uppercase border-b pb-1">Overview Stock (Visual 100%)</h3>
                    <div class="h-[300px] w-full mb-4">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
                <div class="overflow-x-auto border border-gray-100 rounded-lg">
                    <table class="chart-table" id="dataTable">
                        <thead><tr id="tableHeader" class="bg-slate-100"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>

            <div class="w-full lg:w-[25%] flex flex-col gap-4">
                
                <section class="bg-white p-3 rounded-xl shadow-lg border border-gray-200 flex flex-col items-center">
                    <h3 class="text-center font-bold text-slate-800 mb-2 text-[9px] uppercase border-b w-full pb-1">Total Stock (Qty)</h3>
                    <div class="h-[150px] w-full">
                        <canvas id="pieTotalChart"></canvas>
                    </div>
                </section>

                <section class="bg-white p-3 rounded-xl shadow-lg border border-gray-200 flex flex-col items-center">
                    <h3 class="text-center font-bold text-slate-800 mb-2 text-[9px] uppercase border-b w-full pb-1">Product Detail (%)</h3>
                    <div class="h-[150px] w-full">
                        <canvas id="pieDetailChart"></canvas>
                    </div>
                </section>

            </div>
        </div>

        <section class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
            <iframe id="sheetFrame" src="" class="w-full h-[600px] border-none"></iframe>
        </section>
    </main>

    <script>
        const ID_GSHEET = "2PACX-1vShq3eIcceGMXuR6dBbMut6K99pAQZV4g86Aq5DWkP7yrFTGNMPkdfg4y6vbWeofWpFRO4gGNqLE4h8"; 
        const GID_BAR = "0"; 
        const GID_PIE_TOTAL = "252078912"; 
        const GID_PIE_DETAIL = "1764500224"; 
        const ID_LAPORAN = "2PACX-1vRQ6OPRqsuPRmTvAgsJNrU1ISOZ4x-0r1WSmpziuRNdecq42VVxgqferykNrUjJrB-KPWbt_NxgkpFk"; 

        Chart.register(ChartDataLabels);

        let stockChart, pieTotalChart, pieDetailChart;
        const barColors = { PS: "#5b9bd5", PL: "#ed7d31", FIP: "#a5a5a5", MSC: "#ffc000" };
        const pieColors3D = ["#ef4444", "#3b82f6", "#facc15", "#10b981", "#8b5cf6", "#f97316", "#06b6d4", "#ec4899"];

        function renderCharts(rowsBar, rowsTotal, rowsDetail) {
            // --- 1. BAR CHART ---
            const barLabels = rowsBar[0].slice(1).map(l => l.trim());
            const parseR = (row) => row.slice(1).map(v => parseFloat(v.replace(/[^\d.-]/g, '')) || 0);
            const rawBarData = { PS: parseR(rowsBar[1]), PL: parseR(rowsBar[2]), FIP: parseR(rowsBar[3]), MSC: parseR(rowsBar[4]) };

            const ctxBar = document.getElementById('stockChart').getContext('2d');
            if(stockChart) stockChart.destroy();
            stockChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: Object.keys(rawBarData).reverse().map((key, idx) => ({
                        label: key,
                        data: rawBarData[key].map((val, i) => {
                            const total = rawBarData.PS[i] + rawBarData.PL[i] + rawBarData.FIP[i] + rawBarData.MSC[i];
                            return total > 0 ? (val / total) * 100 : 0;
                        }),
                        realData: rawBarData[key],
                        backgroundColor: Object.values(barColors).reverse()[idx]
                    }))
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false }, legend: { display: false } }, scales: { y: { stacked: true, max: 100, ticks: { callback: v => v + '%' } }, x: { stacked: true, ticks: { font: { size: 8 } } } } }
            });

            // --- 2. PIE TOTAL (Label Nama di Dalam) ---
            const totalLabels = rowsTotal[0].map(l => l.trim());
            const totalValues = rowsTotal[1].map(v => parseFloat(v.replace(/[^\d.-]/g, '')) || 0);

            const ctxTotal = document.getElementById('pieTotalChart').getContext('2d');
            if(pieTotalChart) pieTotalChart.destroy();
            pieTotalChart = new Chart(ctxTotal, {
                type: 'pie',
                data: { labels: totalLabels, datasets: [{ data: totalValues, backgroundColor: ["#ef4444", "#3b82f6", "#facc15"], borderWidth: 2 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => ` Qty: ${c.raw.toLocaleString()}` } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 8 },
                            formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex]
                        }
                    } 
                }
            });

            // --- 3. PIE DETAIL (Label Persentase di Dalam) ---
            const detailLabels = rowsDetail[0].map(l => l.trim());
            const detailValues = rowsDetail[1].map(v => parseFloat(v.replace(/[^\d.-]/g, '')) || 0);
            const totalSumDetail = detailValues.reduce((a, b) => a + b, 0);

            const ctxDetail = document.getElementById('pieDetailChart').getContext('2d');
            if(pieDetailChart) pieDetailChart.destroy();
            pieDetailChart = new Chart(ctxDetail, {
                type: 'pie',
                data: { labels: detailLabels, datasets: [{ data: detailValues, backgroundColor: pieColors3D, borderWidth: 1 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => ` Qty: ${c.raw.toLocaleString()}` } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 8 },
                            formatter: (value) => {
                                let pct = (value / totalSumDetail * 100).toFixed(1) + '%';
                                return value > (totalSumDetail * 0.04) ? pct : '';
                            }
                        }
                    } 
                }
            });

            // Update Tabel
            const head = document.getElementById('tableHeader');
            head.innerHTML = '<th class="border-r">Cat</th>' + barLabels.map(l => `<th>${l}</th>`).join('');
            const body = document.getElementById('tableBody');
            body.innerHTML = Object.keys(rawBarData).reverse().map(key => `<tr><td class="font-bold bg-gray-50 border-r text-left px-1"><span class="legend-box" style="background:${barColors[key]}"></span>${key}</td>${rawBarData[key].map(v => `<td>${Math.round(v).toLocaleString()}</td>`).join('')}</tr>`).join('');
        }

        async function fetchData() {
            document.getElementById('loader').style.display = "block";
            try {
                const ts = new Date().getTime();
                const fetchCSV = (gid, range) => fetch(`https://docs.google.com/spreadsheets/d/e/${ID_GSHEET}/pub?gid=${gid}&range=${range}&output=csv&t=${ts}`).then(r => r.text());
                
                const [csvBar, csvTotal, csvDetail] = await Promise.all([
                    fetchCSV(GID_BAR, "A1:N5"),
                    fetchCSV(GID_PIE_TOTAL, "A1:C2"),
                    fetchCSV(GID_PIE_DETAIL, "A1:H2") 
                ]);

                renderCharts(
                    csvBar.split('\n').map(r => r.split(',')),
                    csvTotal.split('\n').map(r => r.split(',')),
                    csvDetail.split('\n').map(r => r.split(','))
                );
            } catch (e) { console.error("Error Loading Data"); }
            document.getElementById('loader').style.display = "none";
        }

        function refreshAll() {
            document.getElementById('sheetFrame').src = `https://docs.google.com/spreadsheets/d/e/${ID_LAPORAN}/pubhtml?widget=true&headers=false`;
            fetchData();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const mc = document.getElementById('mainContent');
            sb.classList.toggle('sidebar-closed');
            mc.style.marginLeft = sb.classList.contains('sidebar-closed') ? "0" : "14rem";
        }

        window.onload = () => { if(!ID_GSHEET.includes("MASUKKAN")) refreshAll(); };
    </script>
</body>
</html>