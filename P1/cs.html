<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produksi 1 - Cold Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #sidebar { transition: all 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .text-neon-green { color: #4ade80; }
        .bg-neon-green { background-color: #4ade80; }
        .chart-table { width: 100%; border-collapse: collapse; font-size: 9px; color: #1e293b; }
        .chart-table th, .chart-table td { border: 1px solid #cbd5e1; padding: 3px; text-align: center; }
        .chart-table th { background-color: #f1f5f9; font-weight: bold; }
        .legend-box { width: 8px; height: 8px; display: inline-block; margin-right: 4px; border-radius: 2px; }
        
        /* Efek Shadow untuk Pie agar terlihat semi-3D */
        .pie-container { filter: drop-shadow(0px 10px 8px rgba(0,0,0,0.2)); }
        
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #4ade80; border-radius: 50%;
            width: 18px; height: 18px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans overflow-x-hidden">

    <aside id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-[#1e293b] text-white z-50 shadow-2xl">
        <div class="p-6 text-center border-b border-slate-700">
            <div class="border-2 border-neon-green rounded-md py-1 px-2">
                <span class="text-sm font-black uppercase tracking-tighter text-neon-green">PRODUKSI 1</span>
            </div>
        </div>
        <nav class="mt-4 px-2">
            <a href="index.html" class="flex items-center py-2 px-4 mb-1 hover:bg-slate-700 transition rounded-md text-gray-400">üè† Home</a>
            <a href="cs.html" class="flex items-center py-2 px-4 mb-1 bg-neon-green text-black font-bold rounded-md shadow-lg">‚ùÑÔ∏è Cold Storage</a>
        </nav>
    </aside>

    <main id="mainContent" class="ml-56 p-4 main-content">
        <header class="flex justify-between items-center mb-6 bg-[#1e293b] text-white p-3 rounded-lg shadow-md border-l-4 border-neon-green">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="bg-slate-700 p-2 rounded mr-4 hover:bg-slate-600 transition text-xs">‚ò∞ Menu</button>
                <h1 class="text-lg font-bold uppercase tracking-tight">Dashboard <span class="text-neon-green tracking-normal">Cold Storage</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="loader" id="loader"></div>
                <button onclick="refreshAll()" class="bg-neon-green text-black px-4 py-1 rounded text-[10px] font-black hover:bg-green-400 transition shadow-md">üîÑ REFRESH</button>
            </div>
        </header>

        <div class="flex flex-wrap gap-4 mb-8 items-start">
            
            <section class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 w-full lg:w-[73%]">
                <h3 class="text-center font-bold text-slate-800 mb-4 text-[10px] uppercase tracking-widest border-b pb-2">Overview Stock (MT)</h3>
                <div class="h-[300px] w-full mb-4">
                    <canvas id="stockChart"></canvas>
                </div>
                <div class="overflow-x-auto border border-gray-100 rounded-lg">
                    <table class="chart-table" id="dataTable">
                        <thead><tr id="tableHeader" class="bg-slate-100"><th class="px-2 border-r">Cat</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 w-full lg:w-[25%] flex flex-col items-center">
                <h3 class="text-center font-bold text-slate-800 mb-4 text-[10px] uppercase tracking-widest border-b pb-2 w-full">Total Stock (MT)</h3>
                <div class="h-[220px] w-full flex items-center justify-center pie-container">
                    <canvas id="pieChart"></canvas>
                </div>
                <div id="pieCustomLegend" class="mt-6 w-full space-y-2">
                    </div>
            </section>

        </div>

        <section class="bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="bg-slate-800 p-2 px-4 flex justify-between items-center">
                <span class="text-white text-[10px] font-bold uppercase tracking-widest">Detail Laporan Mingguan</span>
                <span class="text-neon-green text-[9px] font-mono uppercase">Live Connection</span>
            </div>
            <iframe id="sheetFrame" src="" class="w-full h-[600px] border-none"></iframe>
        </section>
    </main>

    <script>
        // === ID & GID CONFIG ===
        const ID_GSHEET = "2PACX-1vShq3eIcceGMXuR6dBbMut6K99pAQZV4g86Aq5DWkP7yrFTGNMPkdfg4y6vbWeofWpFRO4gGNqLE4h8"; 
        const GID_BAR = "0"; 
        const GID_PIE = "252078912"; 
        const ID_LAPORAN = "2PACX-1vRQ6OPRqsuPRmTvAgsJNrU1ISOZ4x-0r1WSmpziuRNdecq42VVxgqferykNrUjJrB-KPWbt_NxgkpFk"; 

        let stockChart, pieChart;
        // Warna Bar Chart (PS, PL, FIP, MSC)
        const barColors = { PS: "#5b9bd5", PL: "#ed7d31", FIP: "#a5a5a5", MSC: "#ffc000" };
        // Warna Pie Chart (Merah, Biru, Kuning)
        const pieColors = ["#ef4444", "#3b82f6", "#facc15"]; 

        function renderCharts(rowsBar, rowsPie) {
            // -- LOGIKA BAR CHART --
            const barLabels = rowsBar[0].slice(1).map(l => l.trim());
            const parseRow = (row) => row.slice(1).map(v => parseFloat(v.replace(/[^\d.-]/g, '')) || 0);
            const rawBarData = { PS: parseRow(rowsBar[1]), PL: parseRow(rowsBar[2]), FIP: parseRow(rowsBar[3]), MSC: parseRow(rowsBar[4]) };

            const ctxBar = document.getElementById('stockChart').getContext('2d');
            if(stockChart) stockChart.destroy();
            stockChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: Object.keys(rawBarData).reverse().map((key, idx) => ({
                        label: key,
                        data: rawBarData[key].map((val, i) => {
                            const total = rawBarData.PS[i] + rawBarData.PL[i] + rawBarData.FIP[i] + rawBarData.MSC[i];
                            return total > 0 ? (val / total) * 100 : 0;
                        }),
                        realData: rawBarData[key],
                        backgroundColor: Object.values(barColors).reverse()[idx]
                    }))
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { stacked: true, max: 100, ticks: { callback: v => v + '%' } }, x: { stacked: true } }
                }
            });

            // -- LOGIKA PIE CHART --
            const pieLabels = rowsPie[0].map(l => l.trim());
            const pieData = rowsPie[1].map(v => parseFloat(v.replace(/[^\d.-]/g, '')) || 0);

            const ctxPie = document.getElementById('pieChart').getContext('2d');
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: pieColors,
                        borderWidth: 3,
                        borderColor: ['#b91c1c', '#1d4ed8', '#a16207'], // Border lebih gelap agar terlihat 3D
                        hoverOffset: 15
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } } // Legend bawaan dimatikan, kita pakai custom di bawah
                }
            });

            // -- UPDATE CUSTOM LEGEND PIE (KETERANGAN QTY) --
            const pieLegendDiv = document.getElementById('pieCustomLegend');
            pieLegendDiv.innerHTML = '';
            pieLabels.forEach((label, i) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center text-[11px] border-b border-gray-50 pb-1";
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full mr-2" style="background:${pieColors[i]}"></span>
                        <span class="font-medium text-gray-600">${label}</span>
                    </div>
                    <span class="font-bold text-slate-800">${pieData[i].toLocaleString()} MT</span>
                `;
                pieLegendDiv.appendChild(item);
            });

            // -- UPDATE TABLE BAR --
            const head = document.getElementById('tableHeader');
            head.innerHTML = '<th class="border-r">Cat</th>' + barLabels.map(l => `<th>${l}</th>`).join('');
            const body = document.getElementById('tableBody');
            body.innerHTML = Object.keys(rawBarData).reverse().map(key => `
                <tr>
                    <td class="font-bold bg-gray-50 border-r text-left px-2"><span class="legend-box" style="background:${barColors[key]}"></span>${key}</td>
                    ${rawBarData[key].map(v => `<td>${Math.round(v).toLocaleString()}</td>`).join('')}
                </tr>`).join('');
        }

        async function fetchData() {
            document.getElementById('loader').style.display = "block";
            try {
                const ts = new Date().getTime();
                const resBar = await fetch(`https://docs.google.com/spreadsheets/d/e/${ID_GSHEET}/pub?gid=${GID_BAR}&output=csv&t=${ts}`);
                const csvBar = await resBar.text();
                const rowsBar = csvBar.split('\n').map(r => r.split(','));

                const resPie = await fetch(`https://docs.google.com/spreadsheets/d/e/${ID_GSHEET}/pub?gid=${GID_PIE}&output=csv&t=${ts}`);
                const csvPie = await resPie.text();
                const rowsPie = csvPie.split('\n').map(r => r.split(','));

                renderCharts(rowsBar, rowsPie);
            } catch (e) { console.error("Error fetching data"); }
            document.getElementById('loader').style.display = "none";
        }

        function refreshAll() {
            document.getElementById('sheetFrame').src = `https://docs.google.com/spreadsheets/d/e/${ID_LAPORAN}/pubhtml?widget=true&headers=false`;
            fetchData();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const mc = document.getElementById('mainContent');
            sb.classList.toggle('sidebar-closed');
            mc.style.marginLeft = sb.classList.contains('sidebar-closed') ? "0" : "14rem";
        }

        window.onload = () => { if(!ID_GSHEET.includes("MASUKKAN")) refreshAll(); };
    </script>
</body>
</html>