<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS1 - 2 Hari Terakhir</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f0f2f5; }
        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #fff; display: flex; align-items: center; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1001; }
        .sidebar { width: 250px; height: 100vh; background: #2c3e50; color: white; position: fixed; left: 0; top: 0; transition: 0.3s; z-index: 1000; padding-top: 60px; }
        .main-content { margin-left: 250px; padding: 70px 20px 20px 20px; transition: 0.3s; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        #debug-console { background: #1a1a1a; color: #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 11px; border-radius: 8px; margin-bottom: 20px; max-height: 100px; overflow-y: auto; border: 1px solid #333; }
        h2 { color: #2c3e50; margin-top: 0; }
    </style>
</head>
<body>

<div class="top-bar">
    <span style="font-weight: bold; color: #2c3e50;">‚ùÑÔ∏è Monitoring Cold Storage CS1</span>
</div>

<div class="sidebar" id="mySidebar">
    <div style="padding: 20px; font-size: 14px; color: #bdc3c7;">MENU</div>
    <button style="width:100%; padding:15px; background:transparent; border:none; color:white; text-align:left; cursor:pointer; border-left: 4px solid #1abc9c;">üå°Ô∏è Temperature CS1</button>
</div>

<div class="main-content">
    <div id="debug-console">Sistem siap. Menarik data terakhir dari Sheet...</div>
    
    <div class="card">
        <h2>Grafik Suhu (Data Terbaru di Sheet)</h2>
        <div style="height: 450px;">
            <canvas id="chartCS1"></canvas>
        </div>
    </div>
</div>

<script>
    const urlScript = "https://script.google.com/macros/s/AKfycbyqvAX34sz4DbW3Y_-3cZ6pVa1J3521_S0TM-gt_lcUTSh3OI1ntNLZdq18YECbRR73AQ/exec";
    let myChart = null;

    // Fungsi pembersih angka agar nilai minus terbaca dengan benar
    function toNum(val) {
        if (val === null || val === undefined || val === "") return null;
        let clean = String(val).replace(/,/g, '.').replace(/[^0-9.\-]/g, '');
        let n = parseFloat(clean);
        return isNaN(n) ? null : n;
    }

    async function muatData() {
        const consoleLog = document.getElementById('debug-console');
        try {
            const res = await fetch(urlScript);
            const data = await res.json();

            if (!data || data.length < 2) {
                consoleLog.innerText += "\n> Error: Data tidak ditemukan.";
                return;
            }

            // AMBIL DATA TERBARU (100 baris terakhir = asumsi 2 hari data)
            // Lalu di-reverse agar grafik berjalan dari kiri (lama) ke kanan (baru)
            const rows = data.slice(1).slice(-100).reverse();

            const labels = rows.map(r => {
                let tgl = String(r[0] || "").substring(0, 6);
                let jam = String(r[1] || "").substring(0, 5);
                return tgl + " " + jam;
            });

            // Pemetaan Kolom: P=15, Q=16, R=17, S=18, T=19
            const ds1 = rows.map(r => toNum(r[15]));
            const ds2 = rows.map(r => toNum(r[16]));
            const ds3 = rows.map(r => toNum(r[17]));
            const ds4 = rows.map(r => toNum(r[18]));
            const ds5 = rows.map(r => toNum(r[19]));

            consoleLog.innerText += "\n> Berhasil memuat " + rows.length + " data terbaru.";
            consoleLog.innerText += "\n> Data Terakhir: " + ds1[ds1.length-1] + "¬∞C";
            consoleLog.scrollTop = consoleLog.scrollHeight;

            updateGrafik(labels, ds1, ds2, ds3, ds4, ds5);

        } catch (e) {
            consoleLog.innerText += "\n> Error Koneksi: " + e.message;
        }
    }

    function updateGrafik(labels, p, q, r, s, t) {
        const ctx = document.getElementById('chartCS1').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'R1 (P)', data: p, borderColor: '#ff6384', tension: 0.3, pointRadius: 1 },
                    { label: 'R2 (Q)', data: q, borderColor: '#36a2eb', tension: 0.3, pointRadius: 1 },
                    { label: 'R3 (R)', data: r, borderColor: '#ffce56', tension: 0.3, pointRadius: 1 },
                    { label: 'R4 (S)', data: s, borderColor: '#4bc0c0', tension: 0.3, pointRadius: 1 },
                    { label: 'Ante (T)', data: t, borderColor: '#9966ff', tension: 0.3, pointRadius: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        suggestedMin: -25, 
                        suggestedMax: 15,
                        grid: { color: '#e0e0e0' }
                    },
                    x: {
                        ticks: { autoSkip: true, maxTicksLimit: 12 },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    muatData();
    setInterval(muatData, 60000); // Cek data baru tiap 1 menit
</script>

</body>
</html>