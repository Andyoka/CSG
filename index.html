<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITORING SYSTEM - ALL PHOTO AREAS</title>
    <style>
        :root { --primary: #2c3e50; --accent: #1abc9c; --bg: #f4f7f9; --sidebar: #1e2b37; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar); color: #ecf0f1; display: flex; flex-direction: column; border-right: 1px solid #2c3e50; }
        .logo-area { padding: 25px; text-align: center; background: #162129; border-bottom: 1px solid #2c3e50; }
        .logo-box { font-size: 22px; font-weight: bold; color: white; border: 2px solid var(--accent); display: inline-block; padding: 5px 15px; border-radius: 8px; text-transform: uppercase; }
        .content { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .area-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 25px; border-top: 5px solid var(--accent); }
        .area-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
        .area-title { font-size: 18px; font-weight: bold; color: var(--primary); }
        .area-date { font-size: 11px; color: #7f8c8d; background: #eee; padding: 4px 8px; border-radius: 4px; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .photo-box { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fff; position: relative; }
        .photo-box img { width: 100%; height: 180px; object-fit: cover; cursor: pointer; display: block; background: #f0f0f0; }
        .photo-label { padding: 8px; font-size: 9px; text-align: center; color: #7f8c8d; border-top: 1px solid #f9f9f9; word-break: break-all; }
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <strong>‚ùÑÔ∏è DOCUMENTATION <span style="color:var(--accent)">SYSTEM</span></strong>
    <div id="live-clock"></div>
</div>

<div class="main-wrapper">
    <div class="sidebar">
        <div class="logo-area"><div class="logo-box">PHOTO</div></div>
        <div style="padding: 20px; font-size: 12px; color: #7f8c8d;">NAVIGASI</div>
        <div style="padding: 12px 25px; color: var(--accent); background: #162129; border-left: 4px solid var(--accent);">üì∑ SEMUA RUANGAN</div>
        <div style="padding: 12px 25px; opacity: 0.5; cursor: not-allowed;">üìä DASHBOARD SUHU</div>
    </div>
    <div class="content" id="gallery-container">
        <div id="loader">Sedang memindai data terbaru dari seluruh kolom...</div>
    </div>
</div>

<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbwes3tRQrHvDhE_l88WieD-ptVuHd2JXM-dq9jdb9M3xwuzQ9eMTjityjxNNc9Jt_mebQ/exec";
    const APP_NAME = "CSGempol-782466966";

    // Pola folder foto sesuai dengan folder di AppSheet/Google Drive
    const AREAS = [
        { name: "RUANG 1", table: "RUANG 1", pattern: "RUANG 1_Images/" },
        { name: "RUANG 2", table: "RUANG 2", pattern: "RUANG 2_Images/" },
        { name: "RUANG 3", table: "RUANG 3", pattern: "RUANG 3_Images/" },
        { name: "RUANG 4", table: "RUANG 4", pattern: "RUANG 4_Images/" },
        { name: "RUANG A", table: "RUANG A", pattern: "RUANG A_Images/" },
        { name: "RUANG B", table: "RUANG B", pattern: "RUANG B_Images/" },
        { name: "RUANG C", table: "RUANG C", pattern: "RUANG C_Images/" },
        { name: "ANTEROOM SELATAN", table: "ANTEROOM SELATAN", pattern: "Anteroom selatan" },
        { name: "ANTEROOM UTARA", table: "ANTEROOM UTARA", pattern: "Anteroom utara" }
    ];

    async function fetchData() {
        try {
            const response = await fetch(URL_API + "?t=" + new Date().getTime());
            const data = await response.json();
            buildGallery(data);
        } catch (err) {
            document.getElementById('gallery-container').innerHTML = "Gagal memuat data dari Spreadsheet.";
        }
    }

    function buildGallery(data) {
        const container = document.getElementById('gallery-container');
        container.innerHTML = "";
        
        // Membalik data: Mencari dari baris paling bawah (Input Terbaru)
        const reversedRows = [...data].reverse();

        AREAS.forEach(area => {
            let photoFiles = [];
            let dateInfo = "N/A";

            // SCANNER LOGIC: Memeriksa setiap baris sampai ketemu foto terbaru area tersebut
            for (let row of reversedRows) {
                const cells = Object.values(row);
                // Cari semua sel di baris ini yang mengandung pattern folder foto
                const foundPhotos = cells.filter(c => c && c.toString().includes(area.pattern));
                
                if (foundPhotos.length > 0) {
                    photoFiles = foundPhotos;
                    // Ambil sel terdekat yang berisi format tanggal
                    const dateCell = cells.find(c => c && c.toString().includes("/202"));
                    const timeCell = cells.find(c => c && c.toString().includes("."));
                    dateInfo = `${dateCell || ''} ${timeCell || ''}`;
                    break; // Berhenti mencari karena sudah dapat baris TERBARU
                }
            }

            if (photoFiles.length > 0) {
                let cardHtml = `
                <div class="area-card">
                    <div class="area-header">
                        <span class="area-title">${area.name}</span>
                        <span class="area-date">üïí ${dateInfo}</span>
                    </div>
                    <div class="photo-grid">`;

                photoFiles.forEach(fileName => {
                    const imgUrl = `https://www.appsheet.com/template/gettablefileurl?appName=${APP_NAME}&tableName=${encodeURIComponent(area.table)}&fileName=${encodeURIComponent(fileName.toString().trim())}`;
                    
                    cardHtml += `
                    <div class="photo-box">
                        <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/400x300?text=Izin+AppSheet+Ditolak'" onclick="window.open(this.src)">
                        <div class="photo-label">${fileName.toString().split('/').pop()}</div>
                    </div>`;
                });

                cardHtml += `</div></div>`;
                container.innerHTML += cardHtml;
            }
        });
    }

    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleString('id-ID'); }, 1000);
    fetchData();
</script>
</body>
</html>