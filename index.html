<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITORING SYSTEM V8.8 - PHOTO TRACKER</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #1abc9c; --bg: #f4f7f9; --sidebar: #1e2b37; --sub: #162129; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        .header { background: var(--primary); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); color: #ecf0f1; display: flex; flex-direction: column; overflow-y: auto; }
        .logo-area { padding: 25px; text-align: center; background: #162129; border-bottom: 1px solid #2c3e50; }
        .logo-box { font-size: 20px; font-weight: bold; color: white; border: 2px solid var(--accent); display: inline-block; padding: 5px 15px; border-radius: 8px; text-transform: uppercase; }
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 14px; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item.active { background: var(--sub); border-left-color: var(--accent); color: var(--accent); }

        /* Content Area */
        .content { flex: 1; overflow-y: auto; padding: 20px; }
        .area-section { margin-bottom: 40px; }
        .area-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        .area-title { font-size: 18px; font-weight: bold; color: var(--primary); }
        .area-info { font-size: 12px; color: #666; font-weight: normal; }

        /* Grid Foto */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .photo-card { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; position: relative; }
        .photo-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .photo-card img { width: 100%; height: 160px; object-fit: cover; background: #f0f0f0; cursor: pointer; }
        .photo-label { padding: 10px; font-size: 11px; background: #fff; border-top: 1px solid #eee; }
        .id-badge { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.5); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        @media print { .sidebar, .header { display: none !important; } .content { padding: 0; } .photo-grid { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>

<div class="header">
    <strong>‚ùÑÔ∏è MONITORING <span style="color:var(--accent)">SYSTEM</span></strong>
    <div id="live-clock" style="font-family: monospace; font-weight: bold;"></div>
</div>

<div class="main-wrapper">
    <div class="sidebar">
        <div class="logo-area">
            <div class="logo-box" id="dynamicLogo">MYCOM</div>
            <div style="font-size: 10px; color: #7f8c8d; margin-top:5px;">CONTROL PANEL</div>
        </div>
        <div style="padding:15px 20px 5px; font-size:11px; color:#7f8c8d; font-weight:bold;">MENU</div>
        <div class="nav-item active" onclick="switchTab('MYCOM', this)"><span>üìä MONITORING SUHU</span></div>
        <div class="nav-item" onclick="switchTab('FOTO', this)"><span>üì∑ FOTO KEBERSIHAN</span></div>
    </div>

    <div class="content">
        <div id="tab-MYCOM">
            <div style="background:white; padding:20px; border-radius:12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <canvas id="myChart" style="height:400px;"></canvas>
            </div>
        </div>

        <div id="tab-FOTO" style="display:none;">
            <div id="gallery-content">
                <p>Memuat foto dari AppSheet...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // URL API FOTO ANDA
    const URL_FOTO = "https://script.google.com/macros/s/URL_DARI_DEPLOY_BARU_ANDA/exec";

    // Mapping berdasarkan data 7-kolom Anda (4 Foto, 1 ID, 1 Tgl, 1 Jam)
    const AREA_CONFIG = [
        { name: "RUANG 1", start: 0, end: 3, id: 4, tgl: 5, jam: 6 },
        { name: "RUANG 2", start: 7, end: 10, id: 11, tgl: 12, jam: 13 },
        { name: "RUANG 3", start: 14, end: 17, id: 18, tgl: 19, jam: 20 },
        { name: "RUANG 4", start: 21, end: 24, id: 25, tgl: 26, jam: 27 },
        { name: "RUANG A", start: 28, end: 31, id: 32, tgl: 33, jam: 34 },
        { name: "RUANG B", start: 35, end: 38, id: 39, tgl: 40, jam: 41 },
        { name: "RUANG C", start: 42, end: 45, id: 46, tgl: 47, jam: 48 },
        { name: "ANTEROOM UTARA", start: 49, end: 49, id: 50, tgl: 51, jam: 52 }, // Asumsi 1 foto
        { name: "ANTEROOM SELATAN", start: 53, end: 53, id: 54, tgl: 55, jam: 56 } // Asumsi 1 foto
    ];

    async function loadPhotoData() {
        try {
            const res = await fetch(URL_FOTO);
            const data = await res.json();
            renderGallery(data);
        } catch (e) {
            console.error("Gagal muat foto", e);
        }
    }

    function renderGallery(data) {
        const container = document.getElementById('gallery-content');
        container.innerHTML = "";

        AREA_CONFIG.forEach(area => {
            // Cari baris terakhir yang punya data di area ini (mencari dari atas karena data di reverse di Apps Script)
            const latestEntry = data.find(row => {
                const vals = Object.values(row);
                return vals[area.start] || vals[area.end];
            });

            if (latestEntry) {
                const vals = Object.values(latestEntry);
                let html = `
                <div class="area-section">
                    <div class="area-header">
                        <span class="area-title">${area.name}</span>
                        <span class="area-info">Terakhir: ${vals[area.tgl]} | ${vals[area.jam]}</span>
                    </div>
                    <div class="photo-grid">`;

                for (let i = area.start; i <= area.end; i++) {
                    if (vals[i] && vals[i] !== "") {
                        html += `
                        <div class="photo-card">
                            <span class="id-badge">ID: ${vals[area.id]}</span>
                            <img src="https://www.appsheet.com/template/gettablefileurl?appName=LS2Foto-XXXXXX&tableName=Foto%20Ruang%20%26%20Gudang&fileName=${encodeURIComponent(vals[i])}" onclick="window.open(this.src)">
                            <div class="photo-label">Bagian ${i - area.start + 1}</div>
                        </div>`;
                    }
                }
                html += `</div></div>`;
                container.innerHTML += html;
            }
        });
    }

    function switchTab(tab, el) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('dynamicLogo').innerText = tab;
        document.getElementById('tab-MYCOM').style.display = tab === 'MYCOM' ? 'block' : 'none';
        document.getElementById('tab-FOTO').style.display = tab === 'FOTO' ? 'block' : 'none';
        if(tab === 'FOTO') loadPhotoData();
    }

    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleString('id-ID'); }, 1000);
</script>
</body>
</html>