<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Monitoring Cold Storage</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f7f9; }
        .top-bar { height: 50px; background: white; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-content { padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #status { font-size: 12px; color: gray; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="top-bar">
    <strong>MONITORING COLD STORAGE</strong>
</div>

<div class="main-content">
    <div id="status">Menghubungkan ke sensor...</div>
    <div class="card">
        <h3>Grafik Suhu Real-time (CS1 & CS2)</h3>
        <div style="height: 450px;">
            <canvas id="chartUtama"></canvas>
        </div>
    </div>
</div>

<script>
    const urlAppsScript = "https://script.google.com/macros/s/AKfycbyqvAX34sz4DbW3Y_-3cZ6pVa1J3521_S0TM-gt_lcUTSh3OI1ntNLZdq18YECbRR73AQ/exec";

    async function muatData() {
        try {
            const respon = await fetch(urlAppsScript);
            const dataRaw = await respon.json();
            
            if (!dataRaw || dataRaw.length < 2) {
                document.getElementById('status').innerText = "Data kosong di Google Sheets.";
                return;
            }

            // Ambil data tanpa header dan balik urutannya agar kronologis (Lama ke Baru)
            const rows = dataRaw.slice(1).reverse();

            // 1. PROSES LABEL TANGGAL & JAM (Kolom A & B)
            const labels = rows.map(row => {
                let tgl = String(row[0] || "");
                let jam = String(row[1] || "");
                // Ambil 10-Feb dari "10-Feb-2026" dan 23:00 dari jam
                let tglShort = tgl.length > 5 ? tgl.substring(0, 6) : tgl;
                let jamShort = jam.substring(0, 5);
                return tglShort + " " + jamShort;
            });

            // 2. PROSES SUHU (Pastikan jadi angka, jika gagal jadi 0)
            const konversiSuhu = (val) => {
                let n = Number(val);
                return isNaN(n) ? null : n;
            };

            const ds_CS1_R1 = rows.map(r => konversiSuhu(r[15])); // Kolom P
            const ds_CS1_ANT = rows.map(r => konversiSuhu(r[19])); // Kolom T
            const ds_CS2_RA = rows.map(r => konversiSuhu(r[22]));  // Kolom W
            const ds_CS2_ANT = rows.map(r => konversiSuhu(r[25])); // Kolom Z

            // 3. GAMBAR GRAFIK
            const ctx = document.getElementById('chartUtama').getContext('2d');
            
            // Hapus grafik lama jika ada (mencegah tumpang tindih saat reload)
            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'CS1-Ruang 1', data: ds_CS1_R1, borderColor: 'red', tension: 0.3, fill: false },
                        { label: 'CS1-Anteroom', data: ds_CS1_ANT, borderColor: 'orange', tension: 0.3, fill: false },
                        { label: 'CS2-Ruang A', data: ds_CS2_RA, borderColor: 'blue', tension: 0.3, fill: false },
                        { label: 'CS2-Anteroom', data: ds_CS2_ANT, borderColor: 'green', tension: 0.3, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            suggestedMin: -25, 
                            suggestedMax: 10,
                            title: { display: true, text: 'Suhu (Â°C)' }
                        },
                        x: {
                            ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 20 }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            document.getElementById('status').innerText = "Update Terakhir: " + new Date().toLocaleTimeString();

        } catch (e) {
            document.getElementById('status').innerText = "Error: " + e.message;
        }
    }

    // Jalankan pertama kali
    muatData();
    
    // Auto-refresh setiap 1 menit
    setInterval(muatData, 60000);
</script>

</body>
</html>