<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITORING SYSTEM TOTAL</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #1abc9c; --bg: #f4f7f9; --sidebar: #1e2b37; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 240px; background: var(--sidebar); color: #ecf0f1; display: flex; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card-title { font-size: 18px; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
        
        /* Table Style */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9fa; padding: 10px; border-bottom: 2px solid #eee; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* Chart Canvas */
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* Gallery Style */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .photo-box { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fff; }
        .photo-box img { width: 100%; height: 150px; object-fit: cover; display: block; background: #f0f0f0; }
        .photo-label { padding: 5px; font-size: 9px; text-align: center; color: #7f8c8d; }
    </style>
</head>
<body>

<div class="header">
    <strong>‚ùÑÔ∏è SYSTEM MONITORING LENGKAP</strong>
    <div id="live-clock"></div>
</div>

<div class="main-wrapper">
    <div class="sidebar">
        <div style="padding:20px; font-weight:bold; color:var(--accent); text-align:center;">MENU UTAMA</div>
        <a href="#chart-section" style="padding:15px; color:white; text-decoration:none;">üìà CHART SUHU</a>
        <a href="#table-section" style="padding:15px; color:white; text-decoration:none;">üìä TABEL DATA</a>
        <a href="#foto-section" style="padding:15px; color:white; text-decoration:none;">üì∑ GALERI FOTO</a>
    </div>

    <div class="content">
        <div id="chart-section" class="card">
            <div class="card-title">üìà Grafik Tren Suhu (Realtime)</div>
            <div class="chart-container">
                <canvas id="suhuChart"></canvas>
            </div>
        </div>

        <div id="table-section" class="card">
            <div class="card-title">üìä Tabel Status Terakhir</div>
            <table>
                <thead>
                    <tr><th>RUANGAN</th><th>TANGGAL</th><th>JAM</th><th>SUHU</th></tr>
                </thead>
                <tbody id="body-suhu"></tbody>
            </table>
        </div>

        <div id="foto-section">
            <div class="card-title">üì∑ Dokumentasi Foto Kebersihan</div>
            <div id="gallery-container"></div>
        </div>
    </div>
</div>

<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbwes3tRQrHvDhE_l88WieD-ptVuHd2JXM-dq9jdb9M3xwuzQ9eMTjityjxNNc9Jt_mebQ/exec";
    const APP_NAME = "CSGempol-782466966";

    const AREAS = [
        { name: "RUANG 1", table: "RUANG 1", pattern: "RUANG 1_Images/", tgl: 5, jam: 6, suhu: 4 },
        { name: "RUANG 2", table: "RUANG 2", pattern: "RUANG 2_Images/", tgl: 12, jam: 13, suhu: 11 },
        { name: "RUANG 3", table: "RUANG 3", pattern: "RUANG 3_Images/", tgl: 19, jam: 20, suhu: 18 },
        { name: "RUANG 4", table: "RUANG 4", pattern: "RUANG 4_Images/", tgl: 26, jam: 27, suhu: 25 },
        { name: "RUANG A", table: "RUANG A", pattern: "RUANG A_Images/", tgl: 33, jam: 34, suhu: 32 },
        { name: "RUANG B", table: "RUANG B", pattern: "RUANG B_Images/", tgl: 40, jam: 41, suhu: 39 },
        { name: "RUANG C", table: "RUANG C", pattern: "RUANG C_Images/", tgl: 47, jam: 48, suhu: 46 }
    ];

    let myChart;

    async function init() {
        const res = await fetch(URL_API + "?t=" + new Date().getTime());
        const data = await res.json();
        
        renderTable(data);
        renderChart(data);
        renderGallery(data);
    }

    function renderTable(data) {
        const tbody = document.getElementById('body-suhu');
        tbody.innerHTML = "";
        const rev = [...data].reverse();
        AREAS.forEach(a => {
            const last = rev.find(r => Object.values(r)[a.tgl]);
            if(last) {
                const v = Object.values(last);
                tbody.innerHTML += `<tr><td>${a.name}</td><td>${v[a.tgl]}</td><td>${v[a.jam]}</td><td>${v[a.suhu]}¬∞C</td></tr>`;
            }
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('suhuChart').getContext('2d');
        const last10 = data.slice(-10);
        const labels = last10.map(r => Object.values(r)[5] || 'Data'); // Pakai kolom tanggal Ruang 1 sebagai label x

        const datasets = AREAS.map((a, index) => ({
            label: a.name,
            data: last10.map(r => parseFloat(Object.values(r)[a.suhu]) || 0),
            borderColor: `hsl(${index * 50}, 70%, 50%)`,
            fill: false,
            tension: 0.3
        }));

        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderGallery(data) {
        const container = document.getElementById('gallery-container');
        container.innerHTML = "";
        const rev = [...data].reverse();

        AREAS.forEach(area => {
            let photoFiles = [];
            for (let row of rev) {
                const cells = Object.values(row);
                const matches = cells.filter(c => c && c.toString().includes(area.pattern));
                if (matches.length > 0) {
                    photoFiles = matches;
                    break;
                }
            }

            if (photoFiles.length > 0) {
                let html = `<div class="card"><strong>${area.name}</strong><div class="photo-grid">`;
                photoFiles.forEach(f => {
                    const url = `https://www.appsheet.com/template/gettablefileurl?appName=${APP_NAME}&tableName=${encodeURIComponent(area.table)}&fileName=${encodeURIComponent(f)}`;
                    html += `<div class="photo-box"><img src="${url}" onclick="window.open(this.src)"><div class="photo-label">${f.split('/').pop()}</div></div>`;
                });
                container.innerHTML += html + `</div></div>`;
            }
        });
    }

    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleString(); }, 1000);
    init();
</script>
</body>
</html>