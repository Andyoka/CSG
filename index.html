<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Cold Storage Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #monitor { background: #333; color: #0f0; padding: 15px; font-family: monospace; font-size: 12px; border-radius: 5px; margin-bottom: 20px; white-space: pre-wrap; }
        .chart-box { height: 400px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üå°Ô∏è Dashboard Temperature</h2>
    <div id="monitor">Status: Inisialisasi...</div>
    
    <div class="chart-box">
        <canvas id="canvasChart"></canvas>
    </div>
</div>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyqvAX34sz4DbW3Y_-3cZ6pVa1J3521_S0TM-gt_lcUTSh3OI1ntNLZdq18YECbRR73AQ/exec";
    const log = document.getElementById('monitor');

    async function muatData() {
        try {
            log.innerText += "\n[1] Menghubungi Google Sheets...";
            const respon = await fetch(scriptURL);
            const data = await respon.json();

            if (!data || data.length < 2) {
                log.innerText += "\n[!] ERROR: Data diterima tapi kosong!";
                return;
            }

            log.innerText += "\n[2] Data diterima: " + data.length + " baris.";
            
            // Ambil data, buang header, ambil 30 data terakhir saja untuk tes
            const rows = data.slice(1).slice(-30); 

            // PROSES TANGGAL (Kolom A) & JAM (Kolom B)
            const labels = rows.map(r => {
                let t = String(r[0] || "").substring(0, 6); // Ambil "10-Feb"
                let j = String(r[1] || "").substring(0, 5); // Ambil "23:00"
                return t + " " + j;
            });

            // PROSES SUHU (Paksa jadi Angka Desimal)
            // r[15] = Kolom P (CS1), r[22] = Kolom W (CS2)
            const suhu1 = rows.map(r => parseFloat(r[15]) || 0);
            const suhu2 = rows.map(r => parseFloat(r[22]) || 0);

            log.innerText += "\n[3] Contoh Suhu CS1: " + suhu1[suhu1.length-1];
            log.innerText += "\n[4] Menggambar grafik...";

            tampilkanGrafik(labels, suhu1, suhu2);

        } catch (err) {
            log.innerText += "\n[!] GAGAL KONEKSI: " + err.message;
            log.style.color = "red";
        }
    }

    function tampilkanGrafik(labels, d1, d2) {
        const ctx = document.getElementById('canvasChart').getContext('2d');
        if (window.myChartInstance) window.myChartInstance.destroy();

        window.myChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'CS1 Ruang 1', data: d1, borderColor: 'red', tension: 0.3 },
                    { label: 'CS2 Ruang A', data: d2, borderColor: 'blue', tension: 0.3 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        suggestedMin: -25, // Agar suhu -20 terlihat
                        suggestedMax: 5,
                        title: { display: true, text: 'Suhu (¬∞C)' }
                    }
                }
            }
        });
        log.innerText += "\n[5] Selesai! Grafik muncul.";
    }

    muatData();
</script>
</body>
</html>